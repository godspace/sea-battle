<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåä –ú–æ—Ä—Å–∫–æ–π –ë–æ–π - –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    
    <style>
        :root {
            --primary: #000000;
            --secondary: #222222;
            --light: #f5f5f5;
            --success: #00a84f; 
            --danger: #d90000;
            --shadow-dark: rgba(0, 0, 0, 0.4);
        }

        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò –ò –§–û–ù –° –ß–ê–°–¢–ò–¶–ê–ú–ò --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #303030 0%, #101010 100%);
            color: var(--light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .particles-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: moveParticle 20s infinite linear;
        }

        .particle:nth-child(1) { width: 15px; height: 15px; top: 10%; left: 20%; animation-duration: 18s; }
        .particle:nth-child(2) { width: 10px; height: 10px; top: 50%; left: 70%; animation-duration: 25s; }
        .particle:nth-child(3) { width: 20px; height: 20px; top: 80%; left: 5%; animation-duration: 22s; }
        .particle:nth-child(4) { width: 8px; height: 8px; top: 30%; left: 90%; animation-duration: 30s; }
        .particle:nth-child(5) { width: 12px; height: 12px; top: 65%; left: 40%; animation-duration: 15s; }
        .particle:nth-child(6) { width: 7px; height: 7px; top: 15%; left: 60%; animation-duration: 28s; }

        @keyframes moveParticle {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 0.5; }
            50% { transform: translate(100vw, 50vh) rotate(180deg); opacity: 0.2; }
            100% { transform: translate(0, 100vh) rotate(360deg); opacity: 0.5; }
        }

        header {
            background: var(--primary);
            color: white;
            width: 100%;
            text-align: center;
            padding: 25px 0;
            margin-bottom: 30px;
            box-shadow: 0 8px 20px var(--shadow-dark);
            z-index: 10;
        }

        main {
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
            z-index: 5;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 30px var(--shadow-dark);
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 0.8s ease-out;
            color: var(--light);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- –§–û–†–ú–´ –ò –ö–ù–û–ü–ö–ò --- */
        input[type="text"], input[type="password"] {
            padding: 14px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--light);
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s, background-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: var(--success);
            background-color: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        button {
            background: linear-gradient(90deg, #555555 0%, #333333 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s, transform 0.1s;
            padding: 14px;
            border-radius: 8px;
        }

        button:hover:not(:disabled) {
            background: linear-gradient(90deg, #666666 0%, #444444 100%);
            box-shadow: 0 4px 10px var(--shadow-dark);
        }
        
        button:disabled {
            background: #444444;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* –ì–†–£–ü–ü–´ –ö–ù–û–ü–û–ö */
        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .auth-buttons button {
            flex: 1;
            width: 50%;
        }
        
        .placement-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .placement-buttons button {
            padding: 10px 20px;
        }

        /* --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ò –°–û–°–¢–û–Ø–ù–ò–Ø --- */
        #auth-message {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            min-height: 20px;
        }

        .success-message {
            color: var(--success);
            animation: pulse 1s ease-out infinite alternate;
        }

        .error-message {
            color: var(--danger);
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
        
        .logout-button {
            background: var(--danger);
            width: auto;
            padding: 8px 15px;
            margin-top: 10px;
            float: right;
            border-radius: 5px;
        }
        
        /* –ö–ù–û–ü–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ò–ì–†–´ */
        #end-game-button {
            background: #ffaa00;
            padding: 8px 15px;
            width: auto;
            font-size: 14px;
            margin-left: 20px;
        }

        /* --- –°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í (–õ–û–ë–ë–ò) --- */
        #online-players-list {
            list-style: none;
            padding: 0;
        }

        #online-players-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideIn 0.3s ease-out;
        }
        
        .challenge-button {
            background: var(--success);
            padding: 8px 15px;
            width: auto;
            font-size: 14px;
        }
        
        /* --- –ò–ì–†–û–í–´–ï –ü–û–õ–Ø --- */
        .boards {
            display: flex;
            justify-content: space-around;
            gap: 40px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .board-wrapper {
            flex: 1 1 350px;
            text-align: center;
        }
        
        .battleship-board {
            display: grid;
            grid-template-columns: repeat(11, 30px);
            grid-template-rows: repeat(11, 30px);
            border: 2px solid var(--success);
            margin: 15px auto 0;
            width: fit-content;
        }

        .cell {
            width: 30px;
            height: 30px;
            border: 1px solid #444444;
            background-color: #2a2a2a;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .coord {
            background-color: #1a1a1a;
            font-weight: bold;
            color: var(--light);
            border: 1px solid #444444;
        }
        
        .cell:hover:not(.coord):not(.ship):not(.hit):not(.miss):not(.disabled) {
            background-color: #404040;
            transform: scale(1.05);
            z-index: 10;
            cursor: pointer;
        }

        .ship {
            background-color: #777777;
        }

        .hit {
            background-color: var(--danger);
            color: white;
            font-size: 16px;
        }

        .miss {
            background-color: #004488;
            color: white;
            font-size: 16px;
        }
        
        .hit::before { content: 'üí•'; }
        .miss::before { content: '‚Ä¢'; }

        .disabled {
            pointer-events: none;
            opacity: 0.7;
            cursor: not-allowed !important;
        }
        
        .turn-highlight {
            border: 2px solid var(--success) !important;
            box-shadow: 0 0 15px rgba(0, 168, 79, 0.7);
        }
        
        #auth-section {
            width: 100%;
            max-width: 400px;
            margin-top: 50px;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ª–æ–±–±–∏ */
        #return-to-game-card {
            display: none;
            text-align: center;
            border-left: 5px solid var(--success);
        }
    </style>
</head>
<body>
    
    <div class="particles-bg">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <header>
        <h1>üåä –ú–æ—Ä—Å–∫–æ–π –ë–æ–π (Battleship)</h1>
        <p>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –Ω–∞ Supabase Realtime</p>
    </header>

    <main>
        <section id="auth-section" class="card">
            <h2>üîë –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <form id="auth-form">
                <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required>
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å (–¥–ª—è –∑–∞—â–∏—Ç—ã –Ω–∏–∫–∞)" required>
                <div class="auth-buttons">
                    <button type="button" id="signin-button">–í–æ–π—Ç–∏</button>
                    <button type="button" id="signup-button">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>
                <p id="auth-message">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
            </form>
        </section>

        <section id="game-section" style="display: none;">
            <div id="user-info" class="card">
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="current-username"></span>!</h3>
                <p>–í–∞—à ID: <span id="current-user-id"></span>
                <button id="logout-button" class="logout-button">–í—ã–π—Ç–∏</button></p>
            </div>
            
            <div id="return-to-game-card" class="card">
                <h3>üèÉ‚Äç‚ôÇÔ∏è –í—ã –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä–µ</h3>
                <p>–í–∞—à–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∏–≥—Ä–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í–µ—Ä–Ω—É—Ç—å—Å—è –∏ –∑–∞–∫–æ–Ω—á–∏—Ç—å?</p>
                <button id="return-to-game-button" class="challenge-button">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∏–≥—Ä—É</button>
            </div>
            
            <div id="players-list-card" class="card">
                <h2>üë• –ò–≥—Ä–æ–∫–∏ –û–Ω–ª–∞–π–Ω</h2>
                <ul id="online-players-list"></ul>
            </div>
            
            <div id="active-game-info" class="card" style="display: none;">
                <h3>üéÆ –ê–∫—Ç–∏–≤–Ω–∞—è –∏–≥—Ä–∞</h3>
                <p>ID –∫–æ–º–Ω–∞—Ç—ã: <strong id="game-id-display"></strong> | –°–æ–ø–µ—Ä–Ω–∏–∫: <strong id="opponent-name-display"></strong></p>
                <p>–°—Ç–∞—Ç—É—Å: <strong id="game-status-display">–û–∂–∏–¥–∞–Ω–∏–µ...</strong>
                <button id="end-game-button">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É –∏ –≤—ã–π—Ç–∏ –≤ –ª–æ–±–±–∏</button></p> 
                <p id="turn-indicator"></p>
            </div>

            <div id="boards-container" style="display: none;" class="card">
                <h2 id="boards-title">üõ•Ô∏è –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π</h2>
                <div id="ship-placement-instructions">
                    <p>–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∫–æ—Ä–∞–±–ª–∏. –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ <b>0</b> –∏–∑ <b>20</b> –∫–ª–µ—Ç–æ–∫.</p>
                    <div class="placement-buttons">
                        <button type="button" id="random-placement-button">–†–∞–Ω–¥–æ–º–Ω–æ</button>
                        <button type="button" id="start-battle-button" disabled>–ì–û–¢–û–í! üö¢</button>
                    </div>
                </div>

                <div class="boards">
                    <div id="my-board-wrapper" class="board-wrapper">
                        <h3>–í–∞—à–µ –ø–æ–ª–µ</h3>
                        <div id="my-board" class="battleship-board"></div>
                    </div>

                    <div id="opponent-board-wrapper" class="board-wrapper" style="display: none;">
                        <h3>–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞</h3>
                        <div id="opponent-board" class="battleship-board"></div>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û SUPABASE - –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï
        const SUPABASE_URL = 'https://lazsklnncyvqmmwkbzoj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhenNrbG5uY3l2cW1td2tiem9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTI4MTksImV4cCI6MjA3OTIyODgxOX0.XzMQCCleyEqie5Bl3of0Q_SeXMSBkCKhuLJ8CQsuy5w';
        
        let supabase = null;
        const authMessage = document.getElementById('auth-message');
        
        // --- –ì–ê–†–ê–ù–¢–ò–†–£–ï–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Æ ---
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            authMessage.textContent = '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...';
            startMorskoyBoy(); 
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase:", e);
            authMessage.textContent = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Supabase.';
            authMessage.className = 'error-message';
        }

        // 2. –í–°–Ø –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
        function startMorskoyBoy() {
            // --- –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–û–í DOM ---
            const authSection = document.getElementById('auth-section');
            const gameSection = document.getElementById('game-section');
            const currentUsernameSpan = document.getElementById('current-username');
            const currentUserIdSpan = document.getElementById('current-user-id');
            const onlinePlayersList = document.getElementById('online-players-list');
            const logoutButton = document.getElementById('logout-button');
            const activeGameInfo = document.getElementById('active-game-info');
            const boardsContainer = document.getElementById('boards-container');
            const myBoardElement = document.getElementById('my-board');
            const opponentBoardElement = document.getElementById('opponent-board');
            const startBattleButton = document.getElementById('start-battle-button');
            const signinButton = document.getElementById('signin-button');
            const signupButton = document.getElementById('signup-button');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const randomPlacementButton = document.getElementById('random-placement-button');
            const endGameButton = document.getElementById('end-game-button'); 
            
            // –ö–ê–†–¢–û–ß–ö–ê –î–õ–Ø –ö–ù–û–ü–ö–ò –í–û–ó–í–†–ê–¢–ê
            const returnToGameCard = document.getElementById('return-to-game-card');
            const returnToGameButton = document.getElementById('return-to-game-button');
            

            let presenceChannel = null;
            let gameChannel = null;
            let currentUserData = { id: null, username: null, gameId: null }; 
            let currentGameState = null;
            
            const BOARD_SIZE = 10;
            const TOTAL_SHIP_CELLS = 20; 
            let myShipPlacement = []; 
            let isMyTurn = false;
            
            checkAuthStatus(); 
            
            // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ---
            randomPlacementButton.addEventListener('click', placeShipsRandomly);
            returnToGameButton.addEventListener('click', () => checkAndResumeGame(true));
            endGameButton.addEventListener('click', endGameAndLobby); 
            
            logoutButton.addEventListener('click', async () => {
                await cleanUpSession();
                
                authSection.style.display = 'block';
                gameSection.style.display = 'none';
                
                displayAuthMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.', true);
            });
            
            // --- –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –°–û–°–¢–û–Ø–ù–ò–Ø ---
            async function cleanUpSession() {
                if (gameChannel) {
                    supabase.removeChannel(gameChannel);
                    gameChannel = null;
                }
                if (presenceChannel) {
                    try {
                        await presenceChannel.untrack();
                        supabase.removeChannel(presenceChannel);
                    } catch (e) {
                         // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                    }
                    presenceChannel = null;
                }
                
                // –°–±—Ä–æ—Å UI –∏ –¥–∞–Ω–Ω—ã—Ö
                boardsContainer.style.display = 'none';
                activeGameInfo.style.display = 'none';
                currentUserData.gameId = null; 
                myShipPlacement = [];
                returnToGameCard.style.display = 'none'; 
                document.getElementById('players-list-card').style.display = 'block';
                
                // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–æ–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ç–æ–∫
                createBoard(myBoardElement, true, 'placement');
                createBoard(opponentBoardElement, false, 'attack');
            }
            
            // --- –õ–û–ì–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –ò–ì–†–´ (–°–î–ê–ß–ê) ---
            async function endGameAndLobby() {
                if (!currentUserData.gameId) {
                    alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.');
                    return;
                }
                
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏? –ò–≥—Ä–∞ –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è.')) {
                    return;
                }
                
                const opponentId = currentGameState.player1_id === currentUserData.id ? currentGameState.player2_id : currentGameState.player1_id;

                // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã –≤ –ë–î –Ω–∞ 'finished' –∏ –¥–µ–ª–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è - –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
                const { error } = await supabase
                    .from('games')
                    .update({ status: 'finished', winner_id: opponentId }) 
                    .eq('id', currentUserData.gameId);

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS.');
                    return;
                }
                
                alert('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (–≤—ã —Å–¥–∞–ª–∏—Å—å). –í—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç–µ—Å—å –≤ –ª–æ–±–±–∏.');
                
                // 2. –û—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                await cleanUpSession();
                
                // 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è gameId (–Ω–∞ null)
                setupPresence(currentUserData.id, currentUserData.username);
            }

            // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –ò UI ---
            
            function displayAuthMessage(message, isSuccess = true) {
                authMessage.textContent = message;
                authMessage.className = isSuccess ? 'success-message' : 'error-message';
                setTimeout(() => {
                    authMessage.textContent = '';
                    authMessage.className = '';
                }, 5000);
            }

            function resetAuthFields() {
                usernameInput.value = '';
                passwordInput.value = '';
            }

            function updateUI(user, username) {
                authSection.style.display = 'none';
                gameSection.style.display = 'block';
                currentUsernameSpan.textContent = username;
                currentUserIdSpan.textContent = user.id.substring(0, 8) + '...';
                document.getElementById('players-list-card').style.display = 'block';
            }

            // --- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ---

            signinButton.addEventListener('click', async () => {
                if (!supabase) return displayAuthMessage('–ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.', false);

                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                if (!username || !password) return displayAuthMessage('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å.', false);

                const email = username.toLowerCase() + '@battleship.local';
                
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error.message);
                    displayAuthMessage('–û—à–∏–±–∫–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.', false);
                    return;
                }

                currentUserData.id = data.user.id;
                currentUserData.username = username;
                resetAuthFields();
                setupPresence(data.user.id, username);
                updateUI(data.user, username);
                displayAuthMessage(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}! –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.`, true);
                checkAndResumeGame(false); 
            });

            signupButton.addEventListener('click', async () => {
                if (!supabase) return displayAuthMessage('–ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.', false);

                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                
                if (!username || !password) return displayAuthMessage('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å.', false);

                const email = username.toLowerCase() + '@battleship.local';
                
                const { data: authData, error: authError } = await supabase.auth.signUp({ 
                    email, 
                    password,
                    options: { data: { username: username } }
                });

                if (authError) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Auth:', authError.message);
                    if (authError.message.includes('already registered')) {
                        displayAuthMessage('–û—à–∏–±–∫–∞: –≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç.', false);
                    } else {
                        displayAuthMessage('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase.', false);
                    }
                    return;
                }
                
                const { data: { user }, error: userError } = await supabase.auth.getUser();

                if (userError || !user) {
                     console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', userError || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                     displayAuthMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –í–æ–π—Ç–∏.', false);
                     return;
                }
                
                // –ü—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
                const { error: profileError } = await supabase
                    .from('profiles')
                    .upsert({ 
                        id: user.id, 
                        username: username 
                    });

                if (profileError) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', profileError.message);
                    displayAuthMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ PROFILES.', false);
                    return;
                }

                currentUserData.id = user.id;
                currentUserData.username = username;
                resetAuthFields();
                setupPresence(user.id, username);
                updateUI(user, username);
                displayAuthMessage(`üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`, true);
                checkAndResumeGame(false); 
            });
            
            // --- –õ–û–ì–ò–ö–ê –ü–†–ò–°–£–¢–°–¢–í–ò–Ø (–õ–û–ë–ë–ò) ---

            function setupPresence(userId, username) {
                if (presenceChannel) supabase.removeChannel(presenceChannel);
                returnToGameCard.style.display = 'none';

                presenceChannel = supabase.channel('online-players', {
                    config: { presence: { key: userId } }
                });

                presenceChannel.on('presence', { event: 'sync' }, () => {
                    const state = presenceChannel.presenceState();
                    displayOnlinePlayers(state, userId);
                });
                
                presenceChannel.on('broadcast', { event: 'challenge' }, (payload) => {
                    handleIncomingChallenge(payload.payload);
                });

                presenceChannel
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            const activeGame = await getActiveGame();
                            const gameId = activeGame ? activeGame.id : null;
                            await presenceChannel.track({ user_id: userId, username: username, gameId: gameId }); 
                        }
                    });
            }

            function displayOnlinePlayers(state, currentUserId) {
                onlinePlayersList.innerHTML = '';
                const players = [];

                for (const key in state) {
                    const player = state[key][0]; 
                    if (player.user_id !== currentUserId && !player.gameId) {
                        players.push(player);
                    }
                }

                if (players.length === 0) {
                    onlinePlayersList.innerHTML = '<li>–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω. –û–∂–∏–¥–∞–π—Ç–µ...</li>';
                    return;
                }
                
                players.sort((a, b) => a.username.localeCompare(b.username));

                players.forEach(player => {
                    const listItem = document.createElement('li');
                    const isDisabled = currentUserData.gameId ? 'disabled' : '';
                    listItem.innerHTML = `
                        <span>${player.username}</span>
                        <button class="challenge-button" data-user-id="${player.user_id}" data-username="${player.username}" ${isDisabled}>–í—ã–∑–≤–∞—Ç—å üí•</button>
                    `;
                    onlinePlayersList.appendChild(listItem);
                });
            }
            
            // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ –ò –í–´–ó–û–í–û–í ---
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('challenge-button')) {
                    const targetUserId = e.target.dataset.userId;
                    const targetUsername = e.target.dataset.username;
                    sendChallenge(targetUserId, targetUsername);
                }
            });
            
            async function sendChallenge(targetId, targetUsername) {
                if (!supabase || !presenceChannel || currentUserData.gameId) return alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –≤—ã —É–∂–µ –≤ –∏–≥—Ä–µ.');
                
                if (!currentUserData.id) {
                    console.error("–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É –±–µ–∑ currentUserData.id");
                    return alert('–û—à–∏–±–∫–∞: –í–∞—à ID –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
                }
                
                // RPC-–§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ò–ì–†–´
                const { data: game, error: gameError } = await supabase
                    .rpc('create_new_game', { player1_id_param: currentUserData.id })
                    .single(); 
                
                if (gameError) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã —á–µ—Ä–µ–∑ RPC:', gameError.message);
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –¥–ª—è INSERT –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ GAMES (—Ñ—É–Ω–∫—Ü–∏—è RPC)');
                    return;
                }
                
                const gameId = game.id;
                currentUserData.gameId = gameId;

                // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ò–°–£–¢–°–¢–í–ò–Ø
                await presenceChannel.track({ user_id: currentUserData.id, username: currentUserData.username, gameId: gameId });

                await presenceChannel.send({
                    type: 'broadcast',
                    event: 'challenge',
                    payload: {
                        challengerId: currentUserData.id,
                        challengerUsername: currentUserData.username,
                        targetId: targetId,
                        gameId: gameId
                    }
                });

                alert(`–í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–≥—Ä–æ–∫—É ${targetUsername}. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞...`);
                startGame(game, targetUsername);
            }
            
            function handleIncomingChallenge(payload) {
                if (payload.targetId === currentUserData.id && !currentUserData.gameId) {
                    const confirmChallenge = confirm(
                        `–ò–≥—Ä–æ–∫ ${payload.challengerUsername} –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—Å –Ω–∞ –ú–æ—Ä—Å–∫–æ–π –ë–æ–π! –ü—Ä–∏–Ω—è—Ç—å?`
                    );

                    if (confirmChallenge) {
                        joinGame(payload.gameId, payload.challengerUsername);
                    }
                }
            }
            
            async function joinGame(gameId, challengerUsername) {
                currentUserData.gameId = gameId;
                
                // 1. –ü–û–õ–£–ß–ê–ï–ú ID –ò–ì–†–û–ö–ê 1
                const { data: initialGame, error: selectError } = await supabase
                    .from('games')
                    .select('player1_id')
                    .eq('id', gameId)
                    .maybeSingle();

                if (selectError || initialGame === null) {
                    console.error('–û—à–∏–±–∫–∞ SELECT –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏:', selectError || '–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ RLS SELECT –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.', selectError);
                    currentUserData.gameId = null; 
                    return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–≥—Ä—É –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–û—à–∏–±–∫–∞ RLS SELECT).'); 
                }

                const firstTurnId = Math.random() < 0.5 ? initialGame.player1_id : currentUserData.id;

                // 2. –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ì–†–£ - –ò–ì–†–û–ö 2
                const { data: updatedGame, error: updateError } = await supabase
                    .from('games')
                    .update({ 
                        player2_id: currentUserData.id,
                        status: 'placement',
                        current_turn: firstTurnId 
                    })
                    .eq('id', gameId)
                    .select(); 

                if (updateError || !updatedGame || updatedGame.length === 0) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∏–≥—Ä–µ (UPDATE RLS):', updateError || '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ –≤–µ—Ä–Ω—É–ª–æ —Å—Ç—Ä–æ–∫.', updateError);
                    currentUserData.gameId = null;
                    return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ. (–û—à–∏–±–∫–∞ RLS UPDATE –Ω–∞ games)'); 
                }
                
                // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ò–°–£–¢–°–¢–í–ò–Ø
                await presenceChannel.track({ user_id: currentUserData.id, username: currentUserData.username, gameId: gameId });

                alert('–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ! –ù–∞—á–Ω–∏—Ç–µ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ—Ä–∞–±–ª–µ–π.');
                startGame(updatedGame[0], challengerUsername); 
            }

            async function startGame(gameData, opponentUsername) {
                currentGameState = gameData;
                currentUserData.gameId = gameData.id;
                
                activeGameInfo.style.display = 'block';
                boardsContainer.style.display = 'block';
                document.getElementById('game-id-display').textContent = gameData.id.substring(0, 8) + '...';
                document.getElementById('opponent-name-display').textContent = opponentUsername;
                document.getElementById('players-list-card').style.display = 'none';
                returnToGameCard.style.display = 'none';

                // –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–æ–∫
                createBoard(myBoardElement, true, 'placement');
                createBoard(opponentBoardElement, false, 'attack');
                document.getElementById('opponent-board-wrapper').style.display = 'none';

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏
                const myBoard = gameData.player1_id === currentUserData.id ? gameData.player1_board : gameData.player2_board;
                
                if (myBoard && myBoard.ships) {
                    myShipPlacement = myBoard.ships;
                    document.getElementById('ship-placement-instructions').style.display = 'none';
                    document.getElementById('random-placement-button').disabled = true;
                    renderMyBoard(myBoard);
                } else {
                    myShipPlacement = [];
                    document.getElementById('boards-title').textContent = 'üõ•Ô∏è –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π';
                    myBoardElement.classList.remove('disabled');
                    document.getElementById('ship-placement-instructions').style.display = 'block';
                    document.getElementById('random-placement-button').disabled = false;
                    updateShipsRemainingDisplay();
                }
                
                startBattleButton.onclick = () => finishPlacement(gameData.id);

                handleGameUpdate(gameData);
                
                setupGameChannel(gameData.id);
            }
            
            // --- –õ–û–ì–ò–ö–ê –†–ê–ù–î–û–ú–ù–û–ô –†–ê–°–°–¢–ê–ù–û–í–ö–ò ---
            
            function placeShipsRandomly() {
                myShipPlacement = [];
                
                const allCells = [];
                for (let r = 1; r <= BOARD_SIZE; r++) {
                    for (let c = 1; c <= BOARD_SIZE; c++) {
                        allCells.push(`${r}-${c}`);
                    }
                }
                
                let attempts = 0;
                while (myShipPlacement.length < TOTAL_SHIP_CELLS && attempts < 1000) {
                    const randomIndex = Math.floor(Math.random() * allCells.length);
                    const coord = allCells[randomIndex];
                    
                    const [r, c] = coord.split('-').map(Number);
                    
                    if (!isAdjacentToShip(r, c, myShipPlacement)) {
                        myShipPlacement.push(coord);
                        allCells.splice(randomIndex, 1); 
                        attempts = 0;
                    } else {
                        attempts++; 
                    }
                    if (allCells.length === 0) break;
                }
                
                for (const cell of myBoardElement.querySelectorAll('.cell')) {
                    cell.classList.remove('ship');
                    if (myShipPlacement.includes(cell.dataset.coord)) {
                        cell.classList.add('ship');
                    }
                }
                
                updateShipsRemainingDisplay();
                checkPlacementComplete();
            }

            // --- –õ–û–ì–ò–ö–ê –†–ê–°–°–¢–ê–ù–û–í–ö–ò ---

            function createBoard(container, isInteractive, mode) {
                container.innerHTML = '';
                const columns = [' ', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];

                for (let r = 0; r <= BOARD_SIZE; r++) {
                    for (let c = 0; c <= BOARD_SIZE; c++) {
                        const cell = document.createElement('div');
                        
                        if (r === 0 || c === 0) {
                            cell.className = 'coord';
                            cell.textContent = r === 0 ? columns[c] : r;
                        } else {
                            cell.className = 'cell';
                            cell.dataset.row = r;
                            cell.dataset.col = c;
                            cell.dataset.coord = `${r}-${c}`;

                            if (isInteractive) {
                                if (mode === 'placement') {
                                    cell.addEventListener('click', handlePlacementClick);
                                }
                            }
                        }
                        container.appendChild(cell);
                    }
                }
            }
            
            function handlePlacementClick(e) {
                const cell = e.target;
                const coord = cell.dataset.coord;

                if (myShipPlacement.includes(coord)) {
                    myShipPlacement = myShipPlacement.filter(c => c !== coord);
                    cell.classList.remove('ship');
                } else {
                    if (myShipPlacement.length >= TOTAL_SHIP_CELLS) {
                        return alert('–í—Å–µ 20 –∫–ª–µ—Ç–æ–∫ –¥–ª—è –∫–æ—Ä–∞–±–ª–µ–π —É–∂–µ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã.');
                    }

                    if (isAdjacentToShip(parseInt(cell.dataset.row), parseInt(cell.dataset.col))) {
                        return alert('–ö–æ—Ä–∞–±–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–ø—Ä–∏–∫–∞—Å–∞—Ç—å—Å—è (–ø—Ä–∞–≤–∏–ª–æ "–ú–æ—Ä—Å–∫–æ–≥–æ –±–æ—è").');
                    }

                    myShipPlacement.push(coord);
                    cell.classList.add('ship');
                }

                updateShipsRemainingDisplay();
                checkPlacementComplete();
            }

            function isAdjacentToShip(r, c, currentPlacement = myShipPlacement) {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue; 
                        
                        const neighborCoord = `${r + dr}-${c + dc}`;
                        if (currentPlacement.includes(neighborCoord)) {
                            return true;
                        }
                    }
                }
                return false;
            }

            function updateShipsRemainingDisplay() {
                const placed = myShipPlacement.length;
                const instructions = document.getElementById('ship-placement-instructions');
                instructions.querySelector('p').innerHTML = `
                    –†–∞—Å—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∫–æ—Ä–∞–±–ª–∏. –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–æ <b>${placed}</b> –∏–∑ <b>${TOTAL_SHIP_CELLS}</b> –∫–ª–µ—Ç–æ–∫.
                `;
            }

            function checkPlacementComplete() {
                const isComplete = myShipPlacement.length === TOTAL_SHIP_CELLS;
                startBattleButton.disabled = !isComplete;
                return isComplete;
            }
            
            async function finishPlacement(gameId) {
                if (!checkPlacementComplete()) return alert('–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                
                startBattleButton.disabled = true;
                myBoardElement.classList.add('disabled');
                document.getElementById('random-placement-button').disabled = true;
                document.getElementById('ship-placement-instructions').style.display = 'none';

                const fieldToUpdate = currentGameState.player1_id === currentUserData.id ? 'player1_board' : 'player2_board';
                
                const boardData = {
                    ships: myShipPlacement, 
                    hits: [],
                    misses: []
                };

                const updateObject = {};
                updateObject[fieldToUpdate] = boardData;
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
                const { data: currentGame, error: fetchError } = await supabase
                    .from('games')
                    .select('*')
                    .eq('id', gameId)
                    .single();

                if (fetchError) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', fetchError);
                    return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }

                const opponentBoardField = currentGameState.player1_id === currentUserData.id ? 'player2_board' : 'player1_board';
                const opponentBoard = currentGame[opponentBoardField];

                // –ï—Å–ª–∏ —É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ —É–∂–µ –µ—Å—Ç—å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞, –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å
                if (opponentBoard && opponentBoard.ships && opponentBoard.ships.length === TOTAL_SHIP_CELLS) {
                    updateObject['status'] = 'in_progress';
                }

                const { error } = await supabase
                    .from('games')
                    .update(updateObject)
                    .eq('id', gameId);

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
                    return alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä–∞–±–ª–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
                }
            }

            // --- –õ–û–ì–ò–ö–ê GAME STATE –ò REALTIME ---

            function setupGameChannel(gameId) {
                if (gameChannel) supabase.removeChannel(gameChannel);

                gameChannel = supabase.channel(`game-${gameId}`);
                
                gameChannel.on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` },
                    (payload) => {
                        handleGameUpdate(payload.new);
                    }
                ).subscribe();
            }
            
            async function handleGameUpdate(gameData) {
                currentGameState = gameData;
                
                const myBoard = gameData.player1_id === currentUserData.id ? gameData.player1_board : gameData.player2_board;
                const opponentBoard = gameData.player1_id === currentUserData.id ? gameData.player2_board : gameData.player1_board;
                const gameStatusDisplay = document.getElementById('game-status-display');
                const turnIndicator = document.getElementById('turn-indicator');
                const opponentBoardWrapper = document.getElementById('opponent-board-wrapper');
                const myBoardWrapper = document.getElementById('my-board-wrapper');
                
                const myShipsPlaced = myBoard && myBoard.ships && myBoard.ships.length === TOTAL_SHIP_CELLS;
                
                // --- –£–°–õ–û–í–ò–ï –ü–û–ë–ï–î–´/–ü–û–†–ê–ñ–ï–ù–ò–Ø ---
                const isGameOver = checkWinCondition(opponentBoard);
                if (isGameOver && gameData.status !== 'finished') {
                    currentGameState.status = 'finished';
                    const winnerId = currentUserData.id;
                    
                    await supabase.from('games').update({ status: 'finished', winner_id: winnerId }).eq('id', currentGameState.id);
                    return; 
                } else if (gameData.status === 'finished') {
                    gameStatusDisplay.textContent = gameData.winner_id === currentUserData.id ? `üéâ –í–´ –ü–û–ë–ï–î–ò–õ–ò!` : `üò≠ –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.`;
                    turnIndicator.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.';
                    endGameButton.disabled = true;
                    renderMyBoard(myBoard);
                    renderOpponentBoard(opponentBoard);
                    opponentBoardWrapper.classList.remove('turn-highlight');
                    myBoardWrapper.classList.remove('turn-highlight');
                    return;
                }

                if (gameData.status === 'placement') {
                    if (myShipsPlaced) {
                        document.getElementById('ship-placement-instructions').style.display = 'none';
                        gameStatusDisplay.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ, –ø–æ–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç –∫–æ—Ä–∞–±–ª–∏...';
                        document.getElementById('opponent-board-wrapper').style.display = 'none';
                        document.getElementById('boards-title').textContent = 'üõ•Ô∏è –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π';
                        myBoardElement.classList.add('disabled');
                    } else {
                        document.getElementById('ship-placement-instructions').style.display = 'block';
                        gameStatusDisplay.textContent = '–†–∞—Å—Å—Ç–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏ –∫–æ—Ä–∞–±–ª–∏.';
                        document.getElementById('opponent-board-wrapper').style.display = 'none';
                        document.getElementById('boards-title').textContent = 'üõ•Ô∏è –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π';
                        myBoardElement.classList.remove('disabled');
                    }
                    turnIndicator.textContent = ''; 
                    return;
                }
                
                if (gameData.status === 'in_progress') {
                    document.getElementById('boards-title').textContent = '‚öîÔ∏è –ü–æ–ª–µ –ë–æ—è';
                    document.getElementById('ship-placement-instructions').style.display = 'none';
                    opponentBoardWrapper.style.display = 'block';
                    myBoardElement.classList.remove('disabled');

                    isMyTurn = gameData.current_turn === currentUserData.id;
                    gameStatusDisplay.textContent = '–ò–¥–µ—Ç –±–æ–π!';
                    
                    myBoardWrapper.classList.toggle('turn-highlight', !isMyTurn);
                    opponentBoardWrapper.classList.toggle('turn-highlight', isMyTurn);
                    turnIndicator.innerHTML = isMyTurn 
                        ? '<span style="color:var(--success);">‚úÖ –í–ê–® –•–û–î! –ê—Ç–∞–∫—É–π—Ç–µ!</span>' 
                        : '<span style="color:var(--danger);">‚è≥ –•–û–î –ü–†–û–¢–ò–í–ù–ò–ö–ê. –û–∂–∏–¥–∞–π—Ç–µ...</span>';
                }

                renderMyBoard(myBoard);
                renderOpponentBoard(opponentBoard);
            }
            
            function checkWinCondition(opponentBoard) {
                if (!opponentBoard || !opponentBoard.ships || !opponentBoard.hits) return false;
                return opponentBoard.hits.length === TOTAL_SHIP_CELLS;
            }
            
            function handleAttackClick(e) {
                if (!isMyTurn || currentGameState.status !== 'in_progress') return alert('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥ –∏–ª–∏ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å/–æ–∫–æ–Ω—á–µ–Ω–∞!');
                
                const cell = e.target;
                const coord = cell.dataset.coord;

                const targetBoard = currentGameState.player1_id === currentUserData.id ? currentGameState.player2_board : currentGameState.player1_board;
                if (targetBoard.hits.includes(coord) || targetBoard.misses.includes(coord)) {
                    return alert('–í —ç—Ç—É –∫–ª–µ—Ç–∫—É –≤—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏!');
                }
                
                opponentBoardElement.classList.add('disabled');

                fireShot(coord);
            }

            async function fireShot(targetCoord) {
                const targetPlayerField = currentGameState.player1_id === currentUserData.id ? 'player2_board' : 'player1_board';
                const targetBoard = currentGameState.player1_id === currentUserData.id ? currentGameState.player2_board : currentGameState.player1_board;
                
                const opponentId = currentGameState.player1_id === currentUserData.id ? currentGameState.player2_id : currentGameState.player1_id;
                
                let isHit = targetBoard.ships.includes(targetCoord);
                
                const updatedHits = [...targetBoard.hits];
                const updatedMisses = [...targetBoard.misses];

                if (isHit) {
                    updatedHits.push(targetCoord);
                } else {
                    updatedMisses.push(targetCoord);
                }
                
                const updatedBoardData = { 
                    ships: targetBoard.ships, 
                    hits: updatedHits, 
                    misses: updatedMisses 
                };
                
                const updateObject = {};
                updateObject[targetPlayerField] = updatedBoardData;
                updateObject.current_turn = isHit ? currentUserData.id : opponentId; 

                const { error } = await supabase
                    .from('games')
                    .update(updateObject)
                    .eq('id', currentUserData.gameId);

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Å—Ç—Ä–µ–ª–µ:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –≤—ã—Å—Ç—Ä–µ–ª–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS UPDATE.');
                    opponentBoardElement.classList.remove('disabled');
                }
            }
            
            function renderMyBoard(myBoardData) {
                const board = myBoardElement;

                for (const cell of board.querySelectorAll('.cell')) {
                    const coord = cell.dataset.coord;
                    cell.classList.remove('ship', 'hit', 'miss');

                    if (myBoardData && myBoardData.ships.includes(coord)) {
                        cell.classList.add('ship');
                    }
                    
                    if (myBoardData && myBoardData.hits.includes(coord)) {
                        cell.classList.add('hit');
                        cell.classList.remove('ship');
                    }
                    
                    if (myBoardData && myBoardData.misses.includes(coord)) {
                        cell.classList.add('miss');
                    }
                }
            }

            function renderOpponentBoard(opponentBoardData) {
                const board = opponentBoardElement;
                
                board.classList.toggle('disabled', !isMyTurn || currentGameState.status !== 'in_progress');
                
                for (const cell of board.querySelectorAll('.cell')) {
                    const coord = cell.dataset.coord;
                    cell.classList.remove('hit', 'miss');
                    cell.removeEventListener('click', handleAttackClick);
                    
                    if(isMyTurn && currentGameState.status === 'in_progress') {
                        cell.addEventListener('click', handleAttackClick);
                    }

                    if (opponentBoardData && opponentBoardData.hits.includes(coord)) {
                        cell.classList.add('hit');
                    }
                    
                    if (opponentBoardData && opponentBoardData.misses.includes(coord)) {
                        cell.classList.add('miss');
                    }
                }
            }
            
            // --- –õ–û–ì–ò–ö–ê –í–û–ó–í–†–ê–¢–ê –í –ò–ì–†–£ ---

            async function getUsernameById(userId) {
                if (!userId) return '–û–∂–∏–¥–∞–Ω–∏–µ...';
                const { data } = await supabase.from('profiles').select('username').eq('id', userId).maybeSingle();
                return data ? data.username : '–û–∂–∏–¥–∞–Ω–∏–µ...';
            }
            
            async function getActiveGame() {
                 const { data: activeGame } = await supabase
                    .from('games')
                    .select('*')
                    .or(`player1_id.eq.${currentUserData.id},player2_id.eq.${currentUserData.id}`)
                    .in('status', ['placement', 'in_progress'])
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle(); 
                return activeGame;
            }

            async function checkAndResumeGame(clicked) {
                if (clicked) {
                    document.getElementById('players-list-card').style.display = 'none';
                    returnToGameCard.style.display = 'none'; 
                    activeGameInfo.style.display = 'block';
                    document.getElementById('game-status-display').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...';
                }
                
                if (!currentUserData.id) return;

                const activeGame = await getActiveGame();
                
                if (activeGame) {
                    currentUserData.gameId = activeGame.id;
                    
                    const opponentId = activeGame.player1_id === currentUserData.id ? activeGame.player2_id : activeGame.player1_id;
                    const opponentName = await getUsernameById(opponentId);
                        
                    if (clicked) {
                        startGame(activeGame, opponentName);
                    } else {
                        if (activeGame.status !== 'finished') {
                           returnToGameCard.style.display = 'block';
                           document.getElementById('players-list-card').style.display = 'block';
                        }
                    }
                } else {
                    currentUserData.gameId = null;
                    returnToGameCard.style.display = 'none';
                    
                    if (clicked) {
                        alert('–ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∏–≥—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
                    }
                }
            }

            async function checkAuthStatus() {
                if (!supabase) return; 
                
                const { data: { user } } = await supabase.auth.getUser();

                if (user) {
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('id', user.id)
                        .maybeSingle(); 

                    if (!profile) {
                        await supabase.auth.signOut();
                        return;
                    }
                    
                    currentUserData.id = user.id;
                    currentUserData.username = profile.username;

                    setupPresence(user.id, profile.username);
                    updateUI(user, profile.username);
                    
                    await checkAndResumeGame(false); 
                    
                } else {
                    authSection.style.display = 'block';
                    gameSection.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>